<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2022-01-29 Sat 14:04 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Monadology</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Alex Nelson">
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="preconnect" href="https://fonts.gstatic.com"><link href="https://fonts.googleapis.com/css2?family=Spectral&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Merriweather" rel="stylesheet">
<div style="display: none"> \(
\newcommand\D{\mathrm{d}}
\newcommand\E{\mathrm{e}}
\newcommand\I{\mathrm{i}}
\newcommand\bigOh{\mathcal{O}}
\newcommand{\cat}[1]{\mathbf{#1}}
\newcommand\curl{\vec{\nabla}\times}
\newcommand{\CC}{\mathbb{C}}
\newcommand{\NN}{\mathbb{N}}
\newcommand{\QQ}{\mathbb{Q}}
\newcommand{\RR}{\mathbb{R}}
\newcommand{\ZZ}{\mathbb{Z}}
\)</div>
<link rel="stylesheet" type="text/css" href="../../css/stylesheet.css" />
<script type="text/javascript">
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="./index.html"> UP </a>
 |
 <a accesskey="H" href="../../index.html"> HOME </a>
</div><div id="content">
<h1 class="title">Monadology</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#h-fc1853e3-fe90-45e5-b000-ecc1cad4ed65">1. Overview</a></li>
<li><a href="#h-b106ae0d-9e48-4b83-946a-196e0a157a3c">2. State Monad</a></li>
<li><a href="#h-ae2fffc8-6678-42d4-ac03-0bf3c39d9b28">3. Input Output Monad</a>
<ul>
<li><a href="#h-08a4f52f-3779-44f3-981f-8d68675beb2c">3.1. How Haskell Does it&#x2026;</a></li>
<li><a href="#h-9898e93b-cd74-49f3-95cc-681d75bca8a0">3.2. Standard ML Hackery</a></li>
</ul>
</li>
<li><a href="#h-e4b4aced-cb78-493a-8c35-a12e1492cf09">4. References</a>
<ul>
<li><a href="#h-cac676fe-d364-4f03-9c2a-4750ce01619d">4.1. Monads in Haskell</a></li>
<li><a href="#h-9ccaab01-de54-45dd-a3fc-f8c3deab52da">4.2. Monads in Functional Programming (in general)</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-h-fc1853e3-fe90-45e5-b000-ecc1cad4ed65" class="outline-2">
<h2 id="h-fc1853e3-fe90-45e5-b000-ecc1cad4ed65"><span class="section-number-2">1.</span> Overview</h2>
<div class="outline-text-2" id="text-h-fc1853e3-fe90-45e5-b000-ecc1cad4ed65">
<p>
Monads provide a way to reason about side-effects in an equational way.
Basically a monad encodes a computation.
</p>

<div class="org-src-container">
<pre class="src src-sml"><span class="org-keyword">signature</span> <span class="org-interface-def">MONAD</span> =
<span class="org-keyword">sig</span>
    <span class="org-keyword">type</span> 'a <span class="org-type-def">m</span>;
    <span class="org-keyword">val</span> <span class="org-variable-name">return</span> : 'a -&gt; 'a m;
    <span class="org-keyword">val</span> &gt;&gt;= : 'a m * ('a -&gt; 'b m) -&gt; 'b m;
<span class="org-keyword">end</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-h-b106ae0d-9e48-4b83-946a-196e0a157a3c" class="outline-2">
<h2 id="h-b106ae0d-9e48-4b83-946a-196e0a157a3c"><span class="section-number-2">2.</span> State Monad</h2>
<div class="outline-text-2" id="text-h-b106ae0d-9e48-4b83-946a-196e0a157a3c">
<p>
The state monad encodes a computation <code>state -&gt; (a, state)</code>.
</p>

<div class="org-src-container">
<pre class="src src-sml"><span class="org-keyword">signature</span> <span class="org-interface-def">STATE</span> =
<span class="org-keyword">sig</span>
    <span class="org-keyword">type</span> <span class="org-type-def">state</span>;
    <span class="org-keyword">include</span> MONAD <span class="org-keyword">where</span> <span class="org-keyword">type</span> 'a <span class="org-type-def">m</span> = state -&gt; 'a * state;

    <span class="org-comment-delimiter">(* </span><span class="org-comment">core </span><span class="org-comment-delimiter">*)</span>
    <span class="org-keyword">val</span> <span class="org-variable-name">runState</span> : 'a m -&gt; state -&gt; 'a * state;
    <span class="org-keyword">val</span> <span class="org-variable-name">get</span> : state m;
    <span class="org-keyword">val</span> <span class="org-variable-name">put</span> : state -&gt; unit m;

    <span class="org-keyword">val</span> <span class="org-variable-name">modify</span> : (state -&gt; state) -&gt; unit m;
    <span class="org-keyword">val</span> <span class="org-variable-name">gets</span> : (state -&gt; 'a) -&gt; 'a m;
    <span class="org-keyword">val</span> <span class="org-variable-name">evalState</span> : 'a m -&gt; state -&gt; 'a;
    <span class="org-keyword">val</span> <span class="org-variable-name">execState</span> : 'a m -&gt; state -&gt; state;
    <span class="org-keyword">val</span> <span class="org-variable-name">mapState</span> : ('a * state -&gt; 'b * state) -&gt; 'a m -&gt; 'b m;
    <span class="org-keyword">val</span> <span class="org-variable-name">withState</span> : (state -&gt; state) -&gt; 'a m -&gt; 'a m;
<span class="org-keyword">end</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-h-ae2fffc8-6678-42d4-ac03-0bf3c39d9b28" class="outline-2">
<h2 id="h-ae2fffc8-6678-42d4-ac03-0bf3c39d9b28"><span class="section-number-2">3.</span> Input Output Monad</h2>
<div class="outline-text-2" id="text-h-ae2fffc8-6678-42d4-ac03-0bf3c39d9b28">
<p>
When writing output, whether logging a program or displaying information
to the user, we can treat this as a monad of type <code>(output, a)</code> where
<code>a</code> is the value returned from the computation. So <code>getChar</code> would be of
type <code>IO Char</code>, whereas <code>putChar</code> would be of type <code>IO ()</code> (since it
returns nothing, and "nothing" is encoded as the unit type).
</p>

<p>
The intuition (but seeming lie?) is that: Haskell uses
<code>RealWorld -&gt; (RealWorld, a)</code> computation for its <code>IO</code> monad.
So <code>type IO a = RealWorld -&gt; (RealWorld, a)</code>?
</p>
</div>

<div id="outline-container-h-08a4f52f-3779-44f3-981f-8d68675beb2c" class="outline-3">
<h3 id="h-08a4f52f-3779-44f3-981f-8d68675beb2c"><span class="section-number-3">3.1.</span> How Haskell Does it&#x2026;</h3>
<div class="outline-text-3" id="text-h-08a4f52f-3779-44f3-981f-8d68675beb2c">
<p>
Looking through the GHC source code, it seems that the IO Monad is
defined in <a href="https://github.com/ghc/ghc/blob/b73c9c5face16cc8bedf4168ce10770c7cc67f80/libraries/ghc-prim/GHC/Types.hs#L233">ghc-prim/GHC/Types.hs</a> line 233:
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span class="org-doc">{- |</span>
<span class="org-doc">A value of type @'IO' a@ is a computation which, when performed,</span>
<span class="org-doc">does some I\/O before returning a value of type @a@.</span>
<span class="org-doc">There is really only one way to \"perform\" an I\/O action: bind it to</span>
<span class="org-doc">@Main.main@ in your program.  When your program is run, the I\/O will</span>
<span class="org-doc">be performed.  It isn't possible to perform I\/O from an arbitrary</span>
<span class="org-doc">function, unless that function is itself in the 'IO' monad and called</span>
<span class="org-doc">at some point, directly or indirectly, from @Main.main@.</span>
<span class="org-doc">'IO' is a monad, so 'IO' actions can be combined using either the do-notation</span>
<span class="org-doc">or the 'Prelude.&gt;&gt;' and 'Prelude.&gt;&gt;=' operations from the 'Prelude.Monad'</span>
<span class="org-doc">class.</span>
<span class="org-doc">-}</span>
<span class="org-haskell-keyword">newtype</span> <span class="org-haskell-type">IO</span> a <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">IO</span> (<span class="org-haskell-constructor">State#</span> <span class="org-haskell-constructor">RealWorld</span> <span class="org-haskell-operator">-&gt;</span> (<span class="org-haskell-operator">#</span> <span class="org-haskell-constructor">State#</span> <span class="org-haskell-constructor">RealWorld</span>, a <span class="org-haskell-operator">#</span>))
</pre>
</div>

<p>
But it's used all over the place:
</p>

<ul class="org-ul">
<li><a href="https://github.com/ghc/ghc/blob/master/libraries/base/GHC/IO.hs">GHC.IO</a> asserts <code>IO</code> is just an <code>ST</code> monad, "The IO Monad is just an
instance of the ST monad, where the state thread is the real world."</li>
<li>Its monadic structure is defined in <a href="https://github.com/ghc/ghc/blob/0619fb0fb14a98f04aac5f031f6566419fd27495/libraries/base/GHC/Base.hs#L1561-L1565">GHC.Base</a>, Lines 1561&#x2013;1565 (it
seems that <code>bindIO</code> does the heavy lifting).
<ul class="org-ul">
<li>Note: <code>State#</code> and <code>RealWorld</code> are defined in <a href="https://github.com/ghc/ghc/blob/a7f9670e899bcbc87276446a1aac2304cade2b2f/compiler/GHC/Builtin/primops.txt.pp#L2759-L2769">GHC.Builtin.primops</a>
lines 2759&#x2013;2769. They are pseudo-operations.</li>
</ul></li>
</ul>

<p>
Note that <code>bindIO</code> is defined as:
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span class="org-comment-delimiter">--  </span><span class="org-comment">ghc/libraries/base/GHC/Base.hs</span>
<span class="org-haskell-definition">bindIO</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-type">IO</span> a <span class="org-haskell-operator">-&gt;</span> (a <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-type">IO</span> b) <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-type">IO</span> b
<span class="org-haskell-definition">bindIO</span> (<span class="org-haskell-constructor">IO</span> m) k <span class="org-haskell-operator">=</span> <span class="org-haskell-constructor">IO</span> (<span class="org-haskell-operator">\</span> s <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-keyword">case</span> m s <span class="org-haskell-keyword">of</span> (<span class="org-haskell-operator">#</span> new_s, a <span class="org-haskell-operator">#</span>) <span class="org-haskell-operator">-&gt;</span> unIO (k a) new_s)

<span class="org-haskell-definition">unIO</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-type">IO</span> a <span class="org-haskell-operator">-&gt;</span> (<span class="org-haskell-type">State#</span> <span class="org-haskell-type">RealWorld</span> <span class="org-haskell-operator">-&gt;</span> (<span class="org-haskell-operator">#</span> <span class="org-haskell-type">State#</span> <span class="org-haskell-type">RealWorld</span>, a <span class="org-haskell-operator">#</span>))
<span class="org-haskell-definition">unIO</span> (<span class="org-haskell-type">IO</span> a) <span class="org-haskell-operator">=</span> a
</pre>
</div>
<p>
Peyton Jones and Wadler write in their paper, "Imperative Functional Programming", (page 4):
</p>

<blockquote>
<p>
If <code>m :: IO a</code> and <code>k :: a -&gt; IO b</code>, then <code>m `bindIO` k</code> denotes the
action that, when performed, behaves as follows: first perform action
<code>m</code>, yielding a value <code>x</code> of type <code>a</code>, then perform action <code>k x</code>,
yielding a value <code>y</code> of type <code>b</code>, then return value <code>y</code>.
</p>
</blockquote>

<p>
This only makes sense if <code>IO a</code> is a wrapper around <code>(State# RealWorld -&gt; (# State# RealWorld, a #))</code>,
or (less exciting and probably more accurate): things have changed since
January 1993&#x2026;
</p>

<p>
Printing a string in Haskell is done in <a href="https://github.com/ghc/ghc/blob/f90487cacb16e8398c4c4a84de5a1e33ac4e7867/libraries/base/System/IO.hs#L277">System.IO</a>, line 277, for
example:
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span class="org-haskell-definition">putStr</span>          <span class="org-haskell-operator">::</span> <span class="org-haskell-type">String</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-type">IO</span> <span class="org-haskell-constructor">()</span>
<span class="org-haskell-definition">putStr</span> s        <span class="org-haskell-operator">=</span>  hPutStr stdout s
</pre>
</div>

<p>
This delegates the heavy lifting to <a href="https://github.com/ghc/ghc/blob/0619fb0fb14a98f04aac5f031f6566419fd27495/libraries/base/GHC/IO/Handle/Text.hs#L613">GHC.IO.Handle.Text</a> defining
<code>hPutStr</code> (lines 613 <i>et seq.</i>):
</p>

<div class="org-src-container">
<pre class="src src-haskell"><span class="org-haskell-definition">hPutStr</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-type">Handle</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-type">String</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-type">IO</span> <span class="org-haskell-constructor">()</span>
<span class="org-haskell-definition">hPutStr</span> handle str <span class="org-haskell-operator">=</span> hPutStr' handle str <span class="org-haskell-constructor">False</span>

<span class="org-doc">-- | The same as 'hPutStr', but adds a newline character.</span>
<span class="org-haskell-definition">hPutStrLn</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-type">Handle</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-type">String</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-type">IO</span> <span class="org-haskell-constructor">()</span>
<span class="org-haskell-definition">hPutStrLn</span> handle str <span class="org-haskell-operator">=</span> hPutStr' handle str <span class="org-haskell-constructor">True</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">An optimisation: we treat hPutStrLn specially, to avoid the</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">overhead of a single putChar '\n', which is quite high now that we</span>
  <span class="org-comment-delimiter">-- </span><span class="org-comment">have to encode eagerly.</span>

<span class="org-haskell-pragma">{-# NOINLINE hPutStr' #-}</span>
<span class="org-haskell-definition">hPutStr'</span> <span class="org-haskell-operator">::</span> <span class="org-haskell-type">Handle</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-type">String</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-type">Bool</span> <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-type">IO</span> <span class="org-haskell-constructor">()</span>
<span class="org-haskell-definition">hPutStr'</span> handle str add_nl <span class="org-haskell-operator">=</span>
  <span class="org-haskell-keyword">do</span>
    (buffer_mode, nl) <span class="org-haskell-operator">&lt;-</span>
         wantWritableHandle <span class="org-string">"hPutStr"</span> handle <span class="org-haskell-operator">$</span> <span class="org-haskell-operator">\</span>h_ <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-keyword">do</span>
                       bmode <span class="org-haskell-operator">&lt;-</span> getSpareBuffer h_
                       return (bmode, haOutputNL h_)

    <span class="org-haskell-keyword">case</span> buffer_mode <span class="org-haskell-keyword">of</span>
       (<span class="org-haskell-constructor">NoBuffering</span>, <span class="org-haskell-keyword">_</span>) <span class="org-haskell-operator">-&gt;</span> <span class="org-haskell-keyword">do</span>
            hPutChars handle str        <span class="org-comment-delimiter">-- </span><span class="org-comment">v. slow, but we don't care</span>
            when add_nl <span class="org-haskell-operator">$</span> hPutChar handle <span class="org-string">'\n'</span>
       (<span class="org-haskell-constructor">LineBuffering</span>, buf) <span class="org-haskell-operator">-&gt;</span>
            writeBlocks handle <span class="org-haskell-constructor">True</span>  add_nl nl buf str
       (<span class="org-haskell-constructor">BlockBuffering</span> <span class="org-haskell-keyword">_</span>, buf) <span class="org-haskell-operator">-&gt;</span>
            writeBlocks handle <span class="org-haskell-constructor">False</span> add_nl nl buf str
</pre>
</div>
</div>
</div>

<div id="outline-container-h-9898e93b-cd74-49f3-95cc-681d75bca8a0" class="outline-3">
<h3 id="h-9898e93b-cd74-49f3-95cc-681d75bca8a0"><span class="section-number-3">3.2.</span> Standard ML Hackery</h3>
<div class="outline-text-3" id="text-h-9898e93b-cd74-49f3-95cc-681d75bca8a0">
<p>
If I try to do something similar with Standard ML, then I'd guess:
</p>

<div class="org-src-container">
<pre class="src src-sml"><span class="org-keyword">datatype</span> 'a <span class="org-type-def">IO</span> = IO <span class="org-keyword">of</span> (unit -&gt; 'a);

<span class="org-keyword">fun</span> <span class="org-function-name">putStr</span> (s : string) : unit IO = IO (<span class="org-keyword">fn</span> () =&gt; print s);
</pre>
</div>

<p>
This typechecks fine, but it doesn't produce what we'd expect. For
example, in Hamlet:
</p>

<pre class="example" id="orgcddb358">
- putStr "foo";
val it = IO _fn : unit IO
- print "foo\n";
foo
val it = () : unit
</pre>
</div>
</div>
</div>

<div id="outline-container-h-e4b4aced-cb78-493a-8c35-a12e1492cf09" class="outline-2">
<h2 id="h-e4b4aced-cb78-493a-8c35-a12e1492cf09"><span class="section-number-2">4.</span> References</h2>
<div class="outline-text-2" id="text-h-e4b4aced-cb78-493a-8c35-a12e1492cf09">
<ul class="org-ul">
<li><a href="https://www.cl.cam.ac.uk/teaching//1819/ConceptsPL/lectures.pdf">Slides on Programming Languages</a>, pp. 220 <i>et seq.</i>, discuss Monads in
Standard ML.</li>
<li>Robert Harper, <a href="https://existentialtype.wordpress.com/2011/05/01/of-course-ml-has-monads/">Of Course ML Has Monads!</a></li>
<li><a href="https://github.com/msullivan/sml-util/blob/master/hacks/monad.sml">monad.sml</a></li>
<li>Stefan Kahrs,<br>
"First-Class Polymorphism for ML".<br>
In: Sannella D. (eds) Programming Languages and Systems — ESOP '94. ESOP 1994. Lecture Notes in Computer Science, vol 788. Springer, Berlin, Heidelberg. <a href="https://doi.org/10.1007/3-540-57880-3_22">https://doi.org/10.1007/3-540-57880-3_22</a>
<a href="https://kar.kent.ac.uk/21199/">Eprint</a>.
<ul class="org-ul">
<li>This is particularly interesting, an overlooked article which
explicitly gives an example of a monad in Standard ML in section 2.</li>
</ul></li>
<li>Mads Sig Ager, Olivier Danvy, Jan Midtgaard,<br>
"A Functional Correspondence between Monadic Evaluators and Abstract Machinesfor Languages with Computational Effects".<br>
<a href="https://www.brics.dk/RS/03/35/BRICS-RS-03-35.pdf">BRICS</a> preprint, 34 pages; implements monads in Standard ML.</li>
<li>Yutaka Nagashima, Liam O'Connor,<br>
"Close Encounters of the Higher Kind Emulating Constructor Classes in Standard ML".<br>
<a href="https://arxiv.org/abs/1608.03350">arXiv:1608.03350</a>, 3 pages; implements <code>Applicative</code>, <code>Monad</code>,
etc., in Standard ML. The code is <a href="https://www.isa-afp.org/browser_info/current/AFP/Proof_Strategy_Language/files/Constructor_Class.ML.html">available</a>, with some <a href="https://www.isa-afp.org/browser_info/current/AFP/Proof_Strategy_Language/files/Instantiation.ML.html">instances</a>.
(It was discussed on a <a href="https://keens.github.io/blog/2016/10/10/smldemonado/">blog</a>, if you can read Japanese&#x2026;also see <a href="https://github.com/br0ns/PreML">PreML</a>
for <code>do</code>-notation in Standard ML.)</li>
</ul>
</div>

<div id="outline-container-h-cac676fe-d364-4f03-9c2a-4750ce01619d" class="outline-3">
<h3 id="h-cac676fe-d364-4f03-9c2a-4750ce01619d"><span class="section-number-3">4.1.</span> Monads in Haskell</h3>
<div class="outline-text-3" id="text-h-cac676fe-d364-4f03-9c2a-4750ce01619d">
<ul class="org-ul">
<li><a href="https://stackoverflow.com/q/39202738/1296973">Compilation of IORef and STRef</a></li>
<li><a href="https://stackoverflow.com/q/30448007/1296973">What does 'MutVar#' mean?</a></li>
<li>Andrew Butterfield and Glenn Strong,<br>
"Proving Correctness of Programs with IO—A Paradigm Comparison".<br>
In Proceedings of IFL2001.</li>
<li>Wouter Swierstra and Thorsten Altenkirch,<br>
"Beauty in the Beast: A Functional Semantics for the Awkward Squad".<br>
<a href="https://www.cs.nott.ac.uk/~psztxa/publ/beast.pdf">PDF</a> (2007)</li>
<li>Simon Peyton Jones,<br>
"Tackling the Awkward Squad: monadic input/output, concurrency,
 exceptions, and foreign-language calls in Haskell".<br>
 <a href="https://www.microsoft.com/en-us/research/wp-content/uploads/2016/07/mark.pdf?from=https%3A%2F%2Fresearch.microsoft.com%2F%7Esimonpj%2Fpapers%2Fmarktoberdorf%2Fmark.pdf">EPrint</a> (2010)</li>
<li>Jeremy Gibbons and Ralf Hinze,<br>
"Just <code>do</code> It:Simple Monadic Equational Reasoning".<br>
<a href="http://www.cs.ox.ac.uk/jeremy.gibbons/publications/mr.pdf">Eprint</a> (2011)</li>
<li>John Launchbury and Simon Peyton Jones,<br>
"Lazy Functional State Threads".<br>
1994 (discusses <code>IO</code> as a <code>ST</code> instance)</li>
<li>Edsko de Vries,<br>
<a href="https://www.well-typed.com/blog/2014/06/understanding-the-realworld/">Understanding the RealWorld</a></li>
<li><a href="http://blog.ezyang.com/2011/05/unraveling-the-mystery-of-the-io-monad/">Unraveling the mystery of the IO monad</a></li>
</ul>
</div>
</div>


<div id="outline-container-h-9ccaab01-de54-45dd-a3fc-f8c3deab52da" class="outline-3">
<h3 id="h-9ccaab01-de54-45dd-a3fc-f8c3deab52da"><span class="section-number-3">4.2.</span> Monads in Functional Programming (in general)</h3>
<div class="outline-text-3" id="text-h-9ccaab01-de54-45dd-a3fc-f8c3deab52da">
<ul class="org-ul">
<li>Philip Wadler,<br>
"Monads for Functional Programming".<br>
<a href="https://homepages.inf.ed.ac.uk/wadler/papers/marktoberdorf/baastad.pdf">Eprint</a> (1995)</li>
<li>Philip Wadler,<br>
"How to declare an imperative".<br>
<a href="https://homepages.inf.ed.ac.uk/wadler/papers/monadsdeclare/monadsdeclare.ps">PS</a> (1997). Gives an example of reasoning with <code>IO</code> monad.</li>
<li>Philip Wadler and Simon Peyton Jones,<br>
"Imperative Functional Programming".<br>
<a href="https://homepages.inf.ed.ac.uk/wadler/papers/imperative/imperative.ps">PS</a> <a href="https://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.86.9725&amp;rep=rep1&amp;type=pdf">Eprint</a> (1993)</li>
<li>R. Affeldt, D. Nowak, T. Saikawa,<br>
"A Hierarchy of Monadic Effects for Program Verification using
Equational Reasoning".<br>
<a href="https://staff.aist.go.jp/reynald.affeldt/documents/monae.pdf">Eprint</a> discusses using Coq to verify Monadic effects.</li>
</ul>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="postamble">Last Updated 2021-08-09 Mon 18:44.</p>
</div>
</body>
</html>